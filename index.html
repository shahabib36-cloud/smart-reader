<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Reader - Authentic System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --text: #f1f5f9; --header-bg: rgba(15, 23, 42, 0.98);
            --accent: #3b82f6; --border: #334155; --surface: #1e293b;
            --panel: #020617; --sidebar-w: 320px;
            --overlay-tint: transparent;
            --reader-bg: #1e293b;
            --highlight-bg: rgba(59, 130, 246, 0.4);
            --highlight-border: #3b82f6;
        }
        
        body.eye-comfort { --overlay-tint: rgba(255, 191, 0, 0.08); }
        
        /* Light Mode - Real Book Vibe (Design Unchanged) */
        body.light-mode {
            --bg: #f4f1ea; --text: #2c2c2c; --header-bg: rgba(244, 241, 234, 0.98);
            --border: #dcd7c9; --surface: #fffdfa; --panel: #ece8db;
            --reader-bg: #fffdfa; --accent: #5d4037;
            --highlight-bg: rgba(93, 64, 55, 0.15); --highlight-border: #5d4037;
        }

        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--overlay-tint); pointer-events: none; z-index: 9999; transition: 0.3s;
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; transition: 0.4s; overflow-x: hidden; }

        /* Top Bar */
        .top-bar { position: fixed; top: 0; width: 100%; background: var(--header-bg); border-bottom: 1px solid var(--border); z-index: 1000; height: 65px; display: flex; align-items: center; }
        .bar-container { max-width: 1400px; margin: 0 auto; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Sidebar (‚ò∞) Animation (As requested) */
        #sidebar {
            position: fixed; left: calc(-1 * var(--sidebar-w)); top: 0; width: var(--sidebar-w); height: 100%; 
            background: var(--panel); border-right: 1px solid var(--border); z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }
        #sidebar.open { left: 0; }
        .sidebar-content { padding: 20px; flex-grow: 1; overflow-y: auto; }
        
        .active-project-info { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; }

        .project-item { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); position: relative; }
        .project-item.active { border-color: var(--accent); }

        .three-dots { cursor: pointer; padding: 5px; font-size: 18px; color: var(--accent); }
        .action-menu { position: absolute; right: 10px; top: 45px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; display: none; flex-direction: column; z-index: 2100; }
        .action-menu button { background: none; border: none; color: var(--text); padding: 8px 15px; text-align: left; cursor: pointer; }

        /* Settings Toggle */
        .sidebar-settings { padding: 20px; border-top: 1px solid var(--border); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Layout */
        .layout-wrapper { max-width: 1400px; margin: 100px auto 50px; display: grid; grid-template-columns: 280px 1fr 300px; gap: 25px; padding: 0 20px; }
        textarea { width: 100%; height: 75vh; border: 1px solid var(--border); background: var(--surface); color: var(--text); padding: 25px; border-radius: 15px; font-size: 1.1rem; outline: none; resize: none; }
        #reader-view { display: none; font-family: 'Lora', serif; font-size: 22px; line-height: 1.8; white-space: pre-wrap; background: var(--reader-bg); padding: 50px; border-radius: 4px; min-height: 70vh; border: 1px solid var(--border); }
        
        /* Highlight styling */
        .highlight-word { background: var(--highlight-bg); border-bottom: 2px solid var(--highlight-border); border-radius: 3px; transition: 0.3s ease; }

        /* Notebook Sidebar */
        #left-notes-panel { grid-column: 1; display: none; overflow-y: auto; height: 80vh; position: sticky; top: 100px; }
        .note-card { background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--accent); cursor: pointer; position: relative; border: 1px solid var(--border); transition: 0.2s; }
        .note-card:hover { transform: translateX(5px); }
        
        .note-title { font-size: 13px; font-weight: 600; display: block; padding-right: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-sub { opacity: 0.8; margin-top: 4px; display: block; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-note { position: absolute; top: 5px; right: 8px; color: #ff5f5f; font-size: 20px; cursor: pointer; z-index: 10; padding: 0 5px; }

        .btn-action { width: 100%; padding: 12px; margin-top: 10px; background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .btn-action:disabled { cursor: default; opacity: 0.8; border-color: #22c55e; color: #22c55e; }
        
        .nav-btn { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .nav-btn.active { border-color: var(--accent); color: var(--accent); }
        
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: none; z-index: 1500; }
        #rename-box { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--surface); padding:25px; border-radius:15px; z-index:3000; border:1px solid var(--border); }
    </style>
</head>
<body class="light-mode">

<div id="overlay" onclick="closeAll()"></div>

<div id="rename-box">
    <h4 style="margin-top:0;">Rename Project</h4>
    <input type="text" id="new-name-input" style="padding:10px; width:250px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text); outline:none;">
    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
        <button onclick="closeAll()" style="background:none; border:none; color:var(--text); cursor:pointer;">Cancel</button>
        <button onclick="confirmRename()" style="background:var(--accent); border:none; color:white; padding:8px 20px; border-radius:8px; cursor:pointer;">Save</button>
    </div>
</div>

<div id="sidebar">
    <div class="sidebar-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <strong style="font-size:1.2rem;">My Library</strong>
            <span style="cursor:pointer; font-size:20px;" onclick="toggleSidebar()">‚úï</span>
        </div>
        <div id="active-proj-display" class="active-project-info" style="display:none;">
            <div style="color:var(--accent); font-weight:bold; font-size:10px; text-transform:uppercase; margin-bottom:4px; letter-spacing:1px;">Active Text</div>
            <div id="active-proj-name">None</div>
        </div>
        <button onclick="createNewProject()" class="btn-action" style="justify-content:center; border-style:dashed; border-width:2px;">+ New Text</button>
        <div id="project-list" style="margin-top:20px;"></div>
    </div>
    <div class="sidebar-settings">
        <div class="setting-item"><span>Dark Mode</span><label class="switch"><input type="checkbox" id="dark-mode-toggle" onchange="updateThemeSettings()"><span class="slider"></span></label></div>
        <div class="setting-item"><span>Eye Comfort</span><label class="switch"><input type="checkbox" id="eye-comfort-toggle" onchange="updateThemeSettings()"><span class="slider"></span></label></div>
    </div>
</div>

<div class="top-bar">
    <div class="bar-container">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-size:24px; cursor:pointer; padding:5px;" onclick="toggleSidebar()">‚ò∞</div>
            <select id="voice-select" style="background:var(--surface); color:var(--text); border:1px solid var(--border); padding:6px; border-radius:8px; width:140px; outline:none;"></select>
            <button onclick="toggleNotebook()" id="nb-toggle-btn" class="nav-btn">üìì Notebook</button>
            <button onclick="changeFontSize(2)" class="nav-btn">A+</button>
            <button onclick="changeFontSize(-2)" class="nav-btn">A-</button>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <select id="speed-select" style="background:var(--surface); color:var(--text); border:1px solid var(--border); padding:6px; border-radius:8px;">
                <option value="0.5">0.5x</option><option value="0.8">0.8x</option><option value="1.0" selected>1.0x</option><option value="1.5">1.5x</option><option value="2.0">2.0x</option>
            </select>
            <button onclick="toggleView()" id="view-toggle" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">üìñ Read Mode</button>
        </div>
    </div>
</div>

<div class="layout-wrapper">
    <div id="left-notes-panel">
        <h4 style="margin-top:0; color:var(--accent); border-bottom:1px solid var(--border); padding-bottom:10px;">Saved Notes</h4>
        <div id="notes-container"></div>
    </div>
    <div id="editor-view" style="grid-column: 2;">
        <textarea id="main-input" placeholder="Paste your text here..."></textarea>
    </div>
    <div id="reader-view" style="grid-column: 2;"></div>
    <div id="right-panel" style="grid-column: 3; position: sticky; top: 100px; height: fit-content; background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid var(--border); display: none;">
        <div id="trans-text" style="font-size: 1.1rem; margin-bottom: 18px; line-height: 1.5; font-weight:500;">...</div>
        <div id="syllable-section">
            <div id="syllable-text" style="font-size: 1.3rem; font-weight: bold; color: var(--accent); letter-spacing: 2px; margin-bottom: 18px;">...</div>
        </div>
        <button class="btn-action" onclick="speak(lastEn, 'en')">üîä English Voice</button>
        <button class="btn-action" onclick="speak(lastBn, 'bn')">üîä ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</button>
        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
        <button id="add-note-btn" class="btn-action" onclick="addNote()">üìù Add to Notebook</button>
        <button class="btn-action" style="opacity:0.6; justify-content:center; border:none;" onclick="hidePanel()">Dismiss</button>
    </div>
</div>

<script>
    const textarea = document.getElementById('main-input');
    const reader = document.getElementById('reader-view');
    const panel = document.getElementById('right-panel');
    const synth = window.speechSynthesis;

    let currentProjectId = null, lastEn = "", lastBn = "", fontSize = 22, renameTarget = null, isNotebookVisible = false;

    // Theme & Settings Initialize
    function initTheme() {
        const settings = JSON.parse(localStorage.getItem('ai_reader_settings')) || { darkMode: false, eyeComfort: false };
        document.getElementById('dark-mode-toggle').checked = settings.darkMode;
        document.body.classList.toggle('light-mode', !settings.darkMode);
        document.getElementById('eye-comfort-toggle').checked = settings.eyeComfort;
        document.body.classList.toggle('eye-comfort', settings.eyeComfort);
    }

    function updateThemeSettings() {
        const darkMode = document.getElementById('dark-mode-toggle').checked;
        const eyeComfort = document.getElementById('eye-comfort-toggle').checked;
        localStorage.setItem('ai_reader_settings', JSON.stringify({ darkMode, eyeComfort }));
        document.body.classList.toggle('light-mode', !darkMode);
        document.body.classList.toggle('eye-comfort', eyeComfort);
    }

    function changeFontSize(d) { fontSize += d; reader.style.fontSize = fontSize + 'px'; }

    // Notebook Toggle System (DESIGN UNCHANGED)
    function toggleNotebook() {
        isNotebookVisible = !isNotebookVisible;
        const nbPanel = document.getElementById('left-notes-panel');
        const btn = document.getElementById('nb-toggle-btn');
        if (isNotebookVisible) { nbPanel.style.display = 'block'; btn.classList.add('active'); renderNotes(); }
        else { nbPanel.style.display = 'none'; btn.classList.remove('active'); }
    }

    function loadVoices() {
        const v = synth.getVoices().filter(x => x.lang.includes('en'));
        document.getElementById('voice-select').innerHTML = v.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;

    function speak(text, mode) {
        synth.cancel();
        const speed = parseFloat(document.getElementById('speed-select').value);
        if(mode === 'bn') {
            const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=bn&client=tw-ob&ttsspeed=${speed}`;
            new Audio(audioUrl).play();
        } else {
            const u = new SpeechSynthesisUtterance(text);
            u.rate = speed;
            u.voice = synth.getVoices().find(x => x.name === document.getElementById('voice-select').value);
            synth.speak(u);
        }
    }

    async function translateText(text) {
        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=bn&dt=t&q=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data[0].map(part => part[0]).join('');
        } catch (e) { return "Translation error."; }
    }

    function checkNoteStatus(word) {
        const btn = document.getElementById('add-note-btn');
        const projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
        const p = projs.find(x => x.id === currentProjectId);
        const exists = p?.notes?.some(n => n.en.toLowerCase().trim() === word.toLowerCase().trim());
        if(exists) { btn.innerHTML = "Already in Notebook ‚úÖ"; btn.disabled = true; } 
        else { btn.innerHTML = "üìù Add to Notebook"; btn.disabled = false; }
    }

    // --- SMART HIGHLIGHT SYSTEM (Improved) ---
    async function handleNoteClick(word) {
        // Reset and Highlight without regex interference
        reader.innerText = textarea.value; 
        const text = reader.innerText;
        const index = text.toLowerCase().indexOf(word.toLowerCase().trim());

        if (index !== -1) {
            const originalText = text.substring(index, index + word.length);
            // Escape for HTML
            const escapedWord = originalText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedWord})`, 'gi');
            reader.innerHTML = reader.innerHTML.replace(regex, '<span class="highlight-word">$1</span>');
            
            const target = document.querySelector('.highlight-word');
            if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        lastEn = word; panel.style.display = 'block'; checkNoteStatus(word);
        
        if(word.split(' ').length <= 3) {
            document.getElementById('syllable-section').style.display = 'block';
            document.getElementById('syllable-text').innerText = word.match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy](?![aeiouy]))*/gi)?.join('¬∑') || word;
        } else { document.getElementById('syllable-section').style.display = 'none'; }
        
        document.getElementById('trans-text').innerText = "Translating...";
        lastBn = await translateText(word);
        document.getElementById('trans-text').innerText = lastBn;
    }

    // Sidebar Interaction
    function toggleSidebar() { 
        const isOpen = document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').style.display = isOpen ? 'block' : 'none';
        if(isOpen) renderProjects();
    }

    function renderProjects() {
        const projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
        document.getElementById('project-list').innerHTML = projs.map(p => `
            <div class="project-item ${p.id === currentProjectId ? 'active' : ''}">
                <span onclick="loadProject(${p.id})" style="cursor:pointer; flex:1;">${p.name}</span>
                <span class="three-dots" onclick="toggleMenu(event, ${p.id})">‚ãÆ</span>
                <div class="action-menu" id="menu-${p.id}"><button onclick="openRename(${p.id})">Rename</button><button onclick="deleteProject(${p.id})" style="color:#ff5f5f">Delete</button></div>
            </div>
        `).join('');
        const activeProj = projs.find(p => p.id === currentProjectId);
        if(activeProj) { document.getElementById('active-proj-display').style.display = 'block'; document.getElementById('active-proj-name').innerText = activeProj.name; }
    }

    function toggleMenu(e, id) { e.stopPropagation(); document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none'); document.getElementById(`menu-${id}`).style.display = 'flex'; }
    function openRename(id) { renameTarget = id; document.getElementById('rename-box').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; }
    
    function confirmRename() {
        const name = document.getElementById('new-name-input').value.trim();
        if(!name) return;
        let projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
        const p = projs.find(x => x.id === renameTarget); if(p) p.name = name;
        localStorage.setItem('ai_projects', JSON.stringify(projs)); closeAll(); renderProjects();
    }

    function deleteProject(id) {
        let projs = JSON.parse(localStorage.getItem('ai_projects') || '[]').filter(p => p.id !== id);
        if(currentProjectId === id) currentProjectId = null;
        localStorage.setItem('ai_projects', JSON.stringify(projs)); renderProjects();
    }

    function loadProject(id) {
        let p = JSON.parse(localStorage.getItem('ai_projects') || '[]').find(x => x.id === id);
        currentProjectId = id; textarea.value = p.content; reader.innerText = p.content;
        document.getElementById('editor-view').style.display = 'none'; reader.style.display = 'block';
        document.getElementById('view-toggle').innerText = "‚úçÔ∏è Edit Mode"; closeAll(); renderProjects(); renderNotes();
    }

    function createNewProject() { currentProjectId = null; textarea.value = ""; toggleView(); closeAll(); }

    function addNote() {
        let projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
        let p = projs.find(x => x.id === currentProjectId);
        if(p) {
            if(!p.notes) p.notes = [];
            if(!p.notes.some(n => n.en.trim() === lastEn.trim())) {
                p.notes.unshift({ id: Date.now(), en: lastEn, bn: lastBn });
                localStorage.setItem('ai_projects', JSON.stringify(projs)); renderNotes(); checkNoteStatus(lastEn);
            }
        }
    }

    function deleteNoteById(e, noteId) {
        e.stopPropagation();
        let projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
        let p = projs.find(x => x.id === currentProjectId);
        if(p && p.notes) {
            p.notes = p.notes.filter(n => n.id !== noteId);
            localStorage.setItem('ai_projects', JSON.stringify(projs)); renderNotes(); checkNoteStatus(lastEn);
        }
    }

    function renderNotes() {
        let p = JSON.parse(localStorage.getItem('ai_projects') || '[]').find(x => x.id === currentProjectId);
        document.getElementById('notes-container').innerHTML = p?.notes?.map(n => `
            <div class="note-card" onclick="handleNoteClick(\`${n.en.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                <span class="delete-note" onclick="deleteNoteById(event, ${n.id})">‚úï</span>
                <span class="note-title">${n.en}</span>
                <span class="note-sub">${n.bn}</span>
            </div>
        `).join('') || "";
    }

    function toggleView() {
        if (reader.style.display === 'none') {
            const content = textarea.value.trim(); if(!content) return;
            if (!currentProjectId) currentProjectId = Date.now();
            let projs = JSON.parse(localStorage.getItem('ai_projects') || '[]');
            const idx = projs.findIndex(p => p.id === currentProjectId);
            if (idx > -1) projs[idx].content = content;
            else projs.unshift({ id: currentProjectId, name: content.substring(0,20), content, notes: [] });
            localStorage.setItem('ai_projects', JSON.stringify(projs));
            reader.innerText = textarea.value; 
            document.getElementById('editor-view').style.display = 'none'; reader.style.display = 'block';
            document.getElementById('view-toggle').innerText = "‚úçÔ∏è Edit Mode"; renderProjects(); renderNotes();
        } else {
            document.getElementById('editor-view').style.display = 'block'; reader.style.display = 'none';
            document.getElementById('view-toggle').innerText = "üìñ Read Mode"; hidePanel();
        }
    }

    document.addEventListener('mouseup', async () => {
        let s = window.getSelection().toString().trim();
        if (reader.style.display === 'block' && s.length > 0) {
            lastEn = s; panel.style.display = 'block'; checkNoteStatus(s);
            if(s.split(' ').length <= 3) {
                document.getElementById('syllable-section').style.display = 'block';
                document.getElementById('syllable-text').innerText = s.match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy](?![aeiouy]))*/gi)?.join('¬∑') || s;
            } else { document.getElementById('syllable-section').style.display = 'none'; }
            document.getElementById('trans-text').innerText = "Translating...";
            lastBn = await translateText(s); document.getElementById('trans-text').innerText = lastBn;
        }
    });

    function hidePanel() { panel.style.display = 'none'; }
    function closeAll() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').style.display = 'none'; document.getElementById('rename-box').style.display = 'none'; document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none'); }
    window.onload = () => { loadVoices(); initTheme(); };
</script>
</body>

</html>
